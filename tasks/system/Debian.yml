---
- block:
    - name: Make sure apt-transport-https is installed
      apt:
        name: apt-transport-https
        state: present
      register: status
      retries: 10
      delay: 2
      until: status is succeeded

    - name: Add node.js apt key
      apt_key:
        url: https://deb.nodesource.com/gpgkey/nodesource.gpg.key
        state: present
      register: status
      retries: 10
      delay: 2
      until: status is succeeded

    - name: Add node.js repositories
      apt_repository:
        repo: >-
          deb https://deb.nodesource.com/node_{{ nodejs_version }}.x
          {{ ansible_distribution_release }} main
        state: present
        update_cache: True
      register: status
      retries: 10
      delay: 2
      until: status is succeeded

    - name: Install node.js and npm
      package:
        name: "nodejs={{ nodejs_version }}.*"
        state: present
      register: status
      retries: 10
      delay: 2
      until: status is succeeded

    - name: Install build tools
      package:
        name: build-essential
        state: present
      register: status
      retries: 10
      delay: 2
      until: status is succeeded
      when: build_tools
  become: True
